#!/bin/sh
set -eu -o pipefail
exec 3>&1 1>&2

jq . < /dev/stdin > /tmp/input

# SRC=$1

# Usage
#
# resource:
#   - name: jira-approval
#     type: jira-approval-resource
#     check_every: 20s
#     source:
#       jira_account: cycloid-demo
#       jira_user_email: olivier.deturckheim@cycloid.io
#       jira_user_token: 1234567890
# ...
#   - put: jira-approval
#     params:
#       service_desk_id: 1
#       request_type_id: 58
#       summary: "Request to deploy JIRA"
#       description: "Request to deploy JIRA Service Management on AWS instances"

jira_account=$(jq -r '.source.jira_account // empty' /tmp/input)
if [ -z "$jira_account" ]; then
  echo "JIRA account not provided:" >&2
  jq '.source // {}' /tmp/input >&2
  exit 1
fi
echo "Using JIRA account: $jira_account"

jira_user_email=$(jq -r '.source.jira_user_email // empty' /tmp/input)
if [ -z "$jira_user_email" ]; then
  echo "JIRA user email not provided:" >&2
  jq '.source // {}' /tmp/input >&2
  exit 1
fi
echo "Using JIRA user email: $jira_user_email"

jira_user_token=$(jq -r '.source.jira_user_token // empty' /tmp/input)
if [ -z "$jira_user_token" ]; then
  echo "JIRA user token not provided:" >&2
  jq '.source // {}' /tmp/input >&2
  exit 1
fi

service_desk_id=$(jq -r '.params.service_desk_id // empty' /tmp/input)
if [ -z "$service_desk_id" ]; then
  echo "JIRA service desk ID not provided:" >&2
  jq '.params // {}' /tmp/input >&2
  exit 1
fi
echo "Using JIRA service desk ID: $service_desk_id"

request_type_id=$(jq -r '.params.request_type_id // empty' /tmp/input)
if [ -z "$request_type_id" ]; then
  echo "JIRA request type ID not provided:" >&2
  jq '.params // {}' /tmp/input >&2
  exit 1
fi
echo "Using JIRA request type ID: $request_type_id"

summary=$(jq -r '.params.summary // empty' /tmp/input)
if [ -z "$summary" ]; then
  echo "JIRA request type ID not provided:" >&2
  jq '.params // {}' /tmp/input >&2
  exit 1
fi
echo "Using JIRA request summary: $summary"

description=$(jq -r '.params.description // empty' /tmp/input)

response=$(curl -u ${jira_user_email}:${jira_user_token} \
  -H 'Accept: application/json' \
  -H 'Content-Type: application/json' \
  -X POST \
  -d '{"serviceDeskId":"'"${service_desk_id}"'","requestTypeId":"'"${request_type_id}"'","requestFieldValues": {"summary":"'"${summary}"'","description":"'"${description}"'"}}' \
  --url https://${jira_account}.atlassian.net/rest/servicedeskapi/request)
echo "JIRA response: $response"

issueKey=$(echo $response | jq '.issueKey')
currentStatus=$(echo $response | jq '.currentStatus.status')

echo "${issueKey}" >>jiraIssueKeys

echo '{ "version": { "issueKey": '${issueKey}' }, "metadata": [ {"name": "status","value": '${currentStatus}'} ] }' >&3